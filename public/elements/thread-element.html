<link rel="import" href="../components/core-ajax/core-xhr.html">
<link rel="import" href="../components/core-tooltip/core-tooltip.html">
<link rel="import" href="../components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html">

<polymer-element name="thread-element" attributes="tid">
  <template>
    <style>
      .my-comment {
        display: flex;
        margin-top: 4px;
      }
      paper-autogrow-textarea {
        flex-grow: 1;
        margin: 4px 0;
      }
      #body {
        font-family: inherit;
        font-size: small;
        padding: 8px;
        border: 1px solid #ddd;
        box-sizing: border-box;
      }
      .butt {
        color: #ddd;
        padding: 2px;
      }
      .butt::shadow #ripple {
        color: black;
      }
    </style>

    <div id="commentList"></div>

    <div class="my-comment">
      <member-element id="member"></member-element>
      <paper-autogrow-textarea rows="2">
        <textarea id="body" style="width: 100%"></textarea>
      <paper-autogrow-textarea>
    </div>

    <div><core-tooltip label="Comment" style="float: right">
      <paper-icon-button icon="create" class="butt" on-tap="{{createComment}}"></paper-icon-button>
    </core-tooltip></div>

    <core-xhr id="xhr"></core-xhr>
  </template>

  <script>
    function initWebSocket(tid, textarea, list) {
      var url = "ws://localhost:9080/ws/" + tid + "?time=Thu, 01 Jan 2015 00:00:00";
      ws = new WebSocket(url);
      ws.onmessage = function(e) {
        var data = JSON.parse(e.data);
        if (data.body === null) {
          var comments = list.childNodes;
          for (var i = 0; i < comments.length; i++) {
            if (comments[i].cid == data.cid) {
              list.removeChild(comments[i]);
            }
          }
        } else if (data.body !== undefined) {
          var c = document.createElement("comment-element");
          c.cid = data.cid;
          c.user = data.user;
          c.time = data.time;
          c.body = data.body;
          c.textarea = textarea;
          list.appendChild(c);
        }
      };
    }
    Polymer({
      ready: function() {
        this.$.member.user = window.location.search.substr(6);
        this.$.xhr.request({
          url: "/thread/" + this.tid,
          "method": "GET"
        });
        initWebSocket(this.tid, this.$.body, this.$.commentList);
      },
      createComment: function() {
        var _body = this.$.body;
        if (_body.value.trim() == "") return;
        this.$.xhr.request({
          url: "/comment",
          method: "POST",
          headers: {
            "Content-type": "application/json"
          },
          body: JSON.stringify({
            "user": this.$.member.user,
            "tid": this.tid,
            "body": this.$.body.value
          }),
          callback: function() {
            _body.value = "";
          }
        });
      }
    })
  </script>
</polymer-element>
