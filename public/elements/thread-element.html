<link rel="import" href="/platform/bower_components/core-ajax/core-xhr.html">
<link rel="import" href="/platform/bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="/platform/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/platform/bower_components/paper-input/paper-autogrow-textarea.html">
<link rel="import" href="/platform/elements/app-globals/app-globals.html">
<link rel="import" href="/platform/elements/member-select/member-element.html">
<link rel="import" href="/platform/elements/smart-editor/smart-editor.html">
<link rel="import" href="comment-element.html">

<polymer-element name="thread-element" attributes="tid key">
    <template>
        <style>
            member-element /deep/ .element > div {
                width: 100%;
            }
            member-element /deep/ .element > div div span {
                display: none;
            }
            member-element /deep/ .core-tooltip.top {
                margin-bottom: 5px;
            }
            smart-editor /deep/ paper-input-decorator {
                margin-top: -1em;
            }
            .content {
                padding: 0 5px;
            }
            .butt {
                color: #ddd;
                padding: 2px;
            }
            .butt::shadow #ripple {
                color: black;
            }
        </style>

        <div id="commentList"></div>

        <member-element imagesize=36 view="custom" username="{{username}}">
            <div relative class="content">
                <smart-editor id="editor" label="Comment" floatingLabel underline flushKey="ctrl-enter" on-flush="{{flush}}"></smart-editor>
                <core-tooltip label="Comment" position="top" style="float: right">
                    <paper-icon-button icon="done" class="butt" on-tap="{{flush}}"></paper-icon-button>
                </core-tooltip>
            </div>
        </member-element>

        <app-globals id="globals"></app-globals>
        <core-xhr id="xhr"></core-xhr>
    </template>

    <script>
        var _this;

        Polymer({
            newPost: true,
            lastPull: 0,
            since: 0,

            keyChanged: function() {
                _this = this;
                var xhr = this.$.xhr.request({
                    url: "/comment/thread",
                    method: "POST",
                    headers: {"Content-type": "application/x-www-form-urlencoded"},
                    params: {"key": _this.key},
                    callback: function(response) {
                        if (xhr.status == 200 && xhr.readyState == 4) {
                            _this.setNewPost();
                            _this.tid = JSON.parse(response).tid;
                        }
                    }
                });
            },

            tidChanged: function() {
                _this = this;
                this.userid = this.$.globals.values.currentUser.id;
                this.username = this.$.globals.values.currentUser.name;
                setInterval(function() {
                    _this.refreshComment();
                }, 20);
            },

            refreshComment: function() {
                var ts = new Date().getTime();
                if (this.newPost || ts - this.lastPull >= 6000) {
                    this.newPost = false;
                    this.lastPull = ts;
                    this.$.xhr.request({
                        url: "/comment/thread/" + this.tid,
                        method: "GET",
                        params: {"since": this.since},
                        callback: function(response) {
                            var comments = JSON.parse(response)
                            for (var i = 0; i < comments.length; i++) {
                                var c = comments[i];
                                if (c.cid < 0) {
                                    var list = _this.$.commentList.childNodes;
                                    for (var j = 0; j < list.length; j++) {
                                        if ("-" + list[j].cid == c.cid) {
                                            _this.$.commentList.removeChild(list[j]);
                                            break;
                                        }
                                    }
                                } else {
                                    var e = document.createElement("comment-element");
                                    e.cid = c.cid;
                                    e.time = c.time;
                                    e.body = c.body;
                                    e.username = _this.$.globals.values.memberCache[c.user].name;
                                    e.input = _this.$.editor.$.textarea;
                                    e.setNewPost = _this.setNewPost;
                                    if (_this.userid != c.user) {
                                        e.disableDelete = 1;
                                    }
                                    _this.$.commentList.appendChild(e);
                                }
                                _this.since = c.cid;
                            }
                        }
                    });
                }
            },

            setNewPost: function() {
                _this.newPost = true;
            },

            flush: function() {
                var xhr = _this.$.xhr.request({
                    url: "/comment/comment",
                    method: "POST",
                    headers: {"Content-type": "application/json"},
                    body: JSON.stringify({
                        "tid": _this.tid,
                        "body": _this.$.editor.value
                    }),
                    callback: function(response) {
                        if (xhr.status == 200 && xhr.readyState == 4) {
                            _this.newPost = true;
                            _this.$.editor.clearText();
                        }
                    }
                });
            }
        })
    </script>
</polymer-element>
